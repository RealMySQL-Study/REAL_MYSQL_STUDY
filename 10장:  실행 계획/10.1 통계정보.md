~ 5.7 버전까지 :  테이블과 인덱스에 대한 정보를 가지고 실행계획을 수립.<br>
=> 실제 값들의 분포에 대한 정보가 없어서 정확도가 떨어졌음.<br>
=> 8.0 부터는 인덱스되지 않은 컬럼들에해대서도 데이터 분포도를 수집해 저장하는 **히스토그램(Histogram)** 정보가 도입<br>
<br>

# 10.1.1 테이블 및 인덱스 통계 정보

비용 기반 최적화에서 가장 중요한 것은 통계 정보임.<br>
=> 통계정보가 정확하지 않으면 엉뚱한 방향으로 쿼리를 실행

MySql은 비용 기반 최적화를 사용하짐만 다른 DBMS 보다 통계 정보의 정확도가 높지 않고 통계 정보의 휘발성이 강했음.<br>
=> 쿼리 실행 계획을 수입할 때 실제 테이블의 데이터를 일부 분석해서 통계 정보를 보완해서 사용했음.<br>
=> 5.6 버전부터는 통계 정보의 정확성을 높일 수 있는 방법이 제공되기 시작했음<br>
<br>
<br>

## 10.1.1.1 MySql 서버의 통계 정보

5.6 버전부터는 InnoDB 엔진을 사용하는 테이블에 대한 통계정보를 영구적으로 관리할 수 있게 개선.(전에는 메모리에만 관리)<br>
`` innodb_index_stats `` 테이블과 `` innodb_table_stats `` 테이블로 관리할수 있게 개선.
```sql
show tables like '%_stats';
```
![image](https://github.com/RealMySQL-Study/REAL_MYSQL_STUDY/assets/92290312/e40d9f1a-24b4-48ce-81e1-48a4c4272985)

![image](https://github.com/RealMySQL-Study/REAL_MYSQL_STUDY/assets/92290312/5fc7205e-9876-4033-ada6-f4920d45d529)


5.6 에서 테이블을 생성할 때는 STATS_PERSISTENT 옵션을 설정할 수 있는데<br>
이 설정값에 따라 테이블 단위로 영구적인 통계 정보를  보관할지 말지를 결정할 수 있다.
```
CREATE TABLE TAB_TEST(
	FD1 INT,
    FD2 VARCHAR(20),
    primary key(FD1)
)engine=InnoDB
stats_persistent={DEFAULT | 0 | 1}
```
+ 0 : 통계정보를 메모리로만 관리
+ 1 : 통계정보를 영속적으로 관리(테이블)
+ DEFAULT : innodb_stats_persistent 시스템 변수 값으로 결정

innodb_stats_persistent 변수값은 기본적으로 ON으로 설정되어 있음.<br>
![image](https://github.com/RealMySQL-Study/REAL_MYSQL_STUDY/assets/92290312/8ab20029-2f89-4e99-b507-84d4b68f0962)<br>

실제로 stats_persistent 설정 값에 따라 innodb_table_stats 테이블에 관리되는지 확인 가능<br>
![image](https://github.com/RealMySQL-Study/REAL_MYSQL_STUDY/assets/92290312/795e400b-de85-47a0-aba5-6308d6d2adc9)<br>

alter 명령어로 stats_persistent 를 변경 가능<br>
![image](https://github.com/RealMySQL-Study/REAL_MYSQL_STUDY/assets/92290312/056125a8-93c9-41ab-8968-6176930b60f9)<br>


** employees 테이블 예시 **
![image](https://github.com/RealMySQL-Study/REAL_MYSQL_STUDY/assets/92290312/2aa8ec86-f9d7-4a16-ae89-523e6c887e36)<br>

![image](https://github.com/RealMySQL-Study/REAL_MYSQL_STUDY/assets/92290312/e417d6bb-b92c-4717-b111-7b8b70568ec8)<br>

+ innodb_index_stats.stat_name='n_diff_pfx%' : 인덱스가 가진 유니크한 값의 개수
+ innodb_index_stats.stat_name='n_leaf_pages' : 인덱스의 리프노드 페이지 개수
+ innodb_index_stats.stat_name='size' : 인덱스 트리의 전체 페이지 개수
+ innodb_table_stats.n_rows : 테이블 전체 레코드 수
+ innodb_table_stats.clustered_index_size : 프라이머리 키의 크기(InnoDB 페이지 개수)
+ innodb_table_stats.sum_of_other_index_sizes : 프라이머리 키를 제외한 인덱스의 크기(InnoDB 페이지 개수)

> innodb_table_stats.sum_of_other_index_sizes 값은 테이블의 STATS_AUTO_RECALC 옵션에 따라 0으로 보일수도 있음<br>
> 그럴 경우 ``ANALYZE TABLE employees`` 명령을 통해 통계값을 저장할 수 있음

<br>
<br>

5.5 버전 까지틑 테이블 통계가 메모리에서만 관리될 뿐만 아니라 사용자가 알지 못하는 순간에 아래와 같은 이벤트가 발생하면 자동으로 통계 정보가 갱신 됐음.
+ 테이블이 새로 오픈되는 경우
+ 테이블의 레코드가 대량으로 변경되는 경우(1/6 정도)
+ ANALYZE TABLE 명령이 실행되는 경우
+ SHOW TABLE STATUS 명령이나 SHOW INDEX FROM 명령이 실행되는 경우
+ InnoDB 모니터가 활성화되는 경우
+ innodb_status_on_metadata 시스템 설정이 ON인 상태에서 SHOW TABLE STATUS 명령이 실행되는 경우

이렇게 자주 테이블 통계정보가 갱신되면 인덱스 레인지 스캔으로 잘 처리되던 것이 어느날 풀 테이블 스캔으로 실행되는 상황이 발생할 수도 있음.<br>
=> 영구적인 통계 정보가 도입되면서 의도치 않은 통계 정보 변경을 막을 수 있게 됨.<br>

또한 ``innodb_status_auto_recalc`` 시스템 설정 변수의 값을 OFF로 설정해서 통계 정보가 자동으로 갱신 되는 것을 막을 수 있음.<br> 

통계 정보를 자동으로 수집할 지 여부도 테이블 생성 시 STATS_AUTO_RECALC 옵션을 통해 조정할 수 있음.
+  STATS_AUTO_RECALC=1 : 5.5 이전 방식대로 자동 수집
+  STATS_AUTO_RECALC=0 : ANALYZE TABLE 명령을 실행할 때만 수집
+  STATS_AUTO_RECALC=DEFAULT : innodb_stats_auto_recalc 시스템 변수의 값으로 결정

<br>

5.5 버전에서는 테이블 통계 정보를 수집할 때 몇 개의 InnoDB 테이블 블록을 샘플링 할 지 결정하는 옵션으로 innodb_stats_sampl_pages 시스템 설정 변수가 제공.<br>
5.6 부터는 이 옵션이 없어지고 innodb_stats_transient_sample_pages 와 innodb_stats_persistent_sample_pages 시스템 변수 2개로 분리됨.

+ innodb_stats_transient_sample_pages<br>
  기본값 8, 자동르로 통계 정보 수집이 실행될때 8개 페이지만 읨으로 샘플링 해서 분석하고 그 결과를 통계 정보로 활용함을 의미
+ innodb_stats_persistent_sample_pages<br>
  기본값 20, ANALYZE TABLE 명령이 실행되면 임의로 20개 페이지만 샘플링 해서 분석하고 그 결과를 영구적인 통계 정보 테이블에 저장하고 활용함을 의미

정확한 통계 정보를 수집하고 싶으면 innodb_stats_persistent_sample_pages 를 높은 값으로 설정하면 됨<br>
하지만 값이 높을 수록 정보 수집시간이 길어지므로 주의해야함.<br>
<br>
<br>
<br>

# 10.1.2 히스토그램

5.7 버전 까지는 통계정보를 인ㄴ덱스된 컬럼의 유니크한 값의 개수 정도만 가지고 있었음<br>
=> 옵티마이저가 최적의 실행계획을 수립하기에 부족<br>
=> 부족함을 메우기 위해 실행 계획을 수립할 때 실제 인덱스의 일부 페이지를 랜덤으로 가져와 참조하는 방식 사용.

8.0 버전부터는 컬럼의 데이터 분포도를 참조할 수 있는 히스토그램(Histogram) 정보를 활용할 수 있게됨.<br>
<br>
<br>

## 10.1.2.1 히스토그램 정보 수집 및 삭제




























