## 저장공간
CHAR와 VARCHAR의 공통점은 문자열을 저장할 수 있는 데이터 타입이라는 점이고, 가장 큰 차이점은 고정 길이냐 가변길이냐이다.  

* 가변 길이는 최대로 저장할 수 있는 값의 길이는 제한돼 있지만, 그 이하 크기의 값이 저장되면 그만큼 저장 공간이 줄어든다.  
VARCHAR 타입은 저장된 값의 유효 크기가 얼마인지를 별도로 저장해 둬야 하므로 1~2 바이트의 저장공간이 추가로 필요하다.  
* 고정 길이는 실제 저장된 값의 유효 크기가 얼마인지 별도로 저장할 필요가 없으므로 추가로 공간이 필요하지 않다.

하나의 글자를 저장하기 위해 CHAR(1), VARCHAR(1) 타입을 사용할 때 실제 사용되는 저장 공간의 크기를 살펴보자.  
두 문자열 타입 모두 한 글자를 저장할 때 사용하는 문자 집합에 따라 실제 저장 공간은 1 ~ 4 바이트까지 사용한다.  
CHAR 타입에 저장될 때는 추가 공간이 더 필요하지 않지만, VARCHAR 타입에 저장할 때는 문자열의 길이를 관리하기 위한 1~2바이트의 공간을 추가로 더 사용한다.  

VARCHAR 타입의 길이가 255바이트 이하이면 1바이트만 사용하고, 256바이트 이상으로 설정되면 2바이트를 사용한다.  
VARCHAR 타입의 최대 길이는 2바이트로 표현할 수 있는 이상은 사용할 수 없기 때문에 최대 길이는 65,536바이트 이상으로 설정할 수 없다.  

```
주의!

mysql에서는 하나의 레코드에서 TEXT와 BLOB 타입을 제외한 칼럼의 전체 크기가 64KB를 초과할 수 없다.

다른 컬럼에서 40KB의 크기를 사용하고 있다면 VARCHAR타입은 24KB만 사용할 수 있다.
이 때 24KB를 초과하는 크기의 VARCHAR타입을 생성하려고하면, 에러가 발생하거나 자동으로 TEXT타입으로 대체된다.  
```

문자열 값의 길이가 항상 일정하면 CHAR를 사용하고, 가변적이라면 VARCHAR를 사용하는 것이 일반적이다.  
VARCHAR타입을 선택해도 디스크에서 1바이트만 더 사용할 뿐인데, CHAR와 VARCHAR를 결정할 때 길이가 정적이냐 가변적이냐만으로 결정하는것은 적절하지 않다.  

중요한 기준은 다음과 같다.  
* 저장되는 문자열의 길이가 대개 비슷한다?
* 칼럼의 값이 자주 변경되는가?(중요)

```
CREATE TABLE tb_test (
	fd1 INT NOT NULL,
    fd2 CHAR(10) NOT NULL,
    fd3 DATETIME NOT NULL
);

INSERT INTO tb_test (fd1, fd2, fd3) VALUES (1, 'ABCD', '2011-06-27 11:02:11');
```
![image](https://github.com/RealMySQL-Study/REAL_MYSQL_STUDY/assets/67637716/7a4eac23-f1df-4c58-a93b-f3a363fdaf35)  

fd2 칼럼을 VARCHAR(10)으로 바꾸게 되면 다음과 같을 것이다.  
![image](https://github.com/RealMySQL-Study/REAL_MYSQL_STUDY/assets/67637716/29eb5815-7850-455a-be59-b4d7565da675)  

중요한 것은 레코드 한 건이 저장된 상태가 아니라 fd2 칼럼의 값이 변경될 때 어떤 현상이 발생하느냐다.  
fd2 컬럼의 값을 `ABCDE`로 UPDATE 하게되면 다음과 같다.  

* CHAR(10) 은 공간이 이미 10바이트가 준비되어 있으므로 그냥 값만 업데이트 하면된다.
* VARCHAR(10)을 사용하는 칼럼은 길이가 더 큰 값으로 변경될 때는 레코드 자체를 다른 공간으로 옮겨서 저장해야한다.


<br>  
CHAR나 VARCHAR 키워드 뒤에 인자로 전달하는 숫자는 MYSQL에서는 칼람의 바이트 크기가 아니라 문자의 수를 의미한다.  
그래서 CHAR(10) 타입을 사용하더라도 이 칼럼이 실제로 디스크나 메모리에서 사용하는 공간은 각각 달라진다.  

* 영어를 포함한 서구권 언어는 각 문자가 1바이트를 사용하므로 10바이트를 사용한다.
* 한국어나 일본어와 같은 아시아권 언어는 각 문자가 최대 2바이트를 사용하므로 20바이트를 사용한다.
* UTF-8과 같은 유니코드는 최대 4바이트까지 사용하므로 40바이트까지 사용할 수 있다.

## 저장 공간과 스키마 변경(Online DDL)
VARCHAR 타입을 사용하는 칼럼의 길이를 늘리는 작업은 길이에 따라 매우 빠르게 처리될 수도 있지만 어떤 경우에는 테이블에 대해 읽기 잠금을 걸고 레코드를 복사하는 작업이 필요할 수도있다.  

```
CREATE TABLE test (
 id INT PRIMARY KEY,
 value VARCHAR(60)
) DEFAULT CHARSET=utf8mb4
```  

value 칼람의 길이를 63으로 늘리는 경우과 64로 늘리는 경우 Online DDL 명령의 결과는 다음과 같다.  
![image](https://github.com/RealMySQL-Study/REAL_MYSQL_STUDY/assets/67637716/b541e882-7f9d-41ed-a777-604ffd6624aa)  

63으로 늘리는 경우는 잠금 없이 매우 빠르게 변경되었지만 64로 늘리는 경우는 COPY 알고리즘으로 스키마 변경을 실행해야되며 읽기잠금까지 필요로 하게 된다.  
이런 차이가 발생하는 이유는 utf 문자 집합을 사용하는 VARCHAR(60)은 최대 240바이트를 사용하기 때문에 문자열 값의 길이를 저장하는 공간은 1바이트면 된다.  
그러나 VARCHAR(64) 타입은 최대 저장할 수 있는 문자열의 크기가 256바이트까지 가능하므로 문자열 길이를 저장하는 공간의 크기가 2바이트로 바뀌어야 하고,  
이렇게 문자열길이를 저장하는 공간의 크기가 바뀌게 되면, 스키마 변경을 하는 동안 읽기 잠금을 걸고, 테이블의 레코드를 복사하는 방식으로 처리한다.  

## 문자 집합(캐릭터 셋)
mysql 서버에서 각 테이블의 칼럼은 모두 서로 다른 문자 집합을 사용해 문자열 값을 저장할 수 있다.  
CHAR, VARCHAR, TEXT 타입의 칼럼에만 문자집합을 설정할 수 있다.  
MYSQL에서는 관리의 편의를 위해 MYSQL 서버와 DB, 테이블 단위로 기본 문자 집합을 설정할 수 있는 기능을 제공한다.  
한국에서 MYSQL을 사용한다면 euckr이나 utf8mb4만으로 충분하다.  

utf8, utf8mb4차이: utf8은 utfbm4의 부분 집합인데, utfmb4가 도입되기 이전에 주로 사용되었다.  
utf8은 한 글자를 저장하기 위해 1 ~ 3 byte를 사용하기 때문에 utfmb4보다는 저장할 수 있는 문자의 범위가 좁다.  
utf8mb4는 다국어 문자를 포함할 수 있는 칼럼에 사용하기 적합하다.  
euckr은 한국어 전용으로 사용되는 문자 집합이며, 모든 글자는 1 ~ 2 바이트를 사용한다.  

#### 문자 집합 관련 변수
* character_set_filesystem
  * LOAD DATA INFILE ... 또는 SELECT ... INTO OUTFILE 문장을 실행할 때 인자로 지정되는 파일의 이름을 해석할 때 사용되는 문자 집합이다.
  * 데이터 파일의 내용을 읽을 때 사용하는게 아니라 파일의 이름을 찾을 때 사용되는 문자 집합
  * 파일명을 제대로 인식하지 못한다면 이 변수를 utfmb4로 변경하는 것이 좋다.
 * character_set_client
  * 클라이언트가 보낸 sql문장은 이 변수에 설정된 문자 집합으로 인코딩해서 mysql서버로 전송한다.
  * 기본값은 utfmb4이다.
* character_set_connection
  * mysql 서버가 클라이언트로부터 전달받은 sql 문장을 처리하기 위해 이 변수의 문자 집합으로 변환한다.
  * 기본값은 utf8mb4이다.
 

## 콜레이션(Collation)
콜레이션은 문자열 칼럼의 값에 대한 비교나 정렬 순서를 위한 규칙을 의미한다.  
비교나 정렬 작업에서 영문 대소문자를 같은 것으로 처리할지, 아니면 더 크거나 작은 것으로 판단할지에 대한 규칙을 정의하는 것.  

mysql의 모든 문자열 타입의 칼럼은 독립적인 문자 집합과 콜레이션을 가진다.  
각 칼럼에 대해 독립적으로 지정하지 않으면 mysql 서버나 db의 기본 문자 집합과 콜레이션이 자동으로 설정된다.  
각 문자열 칼럼의 값을 비교하거나 정렬할 때는 항상 문자 집합뿐 아니라 콜레이션의 일치 여부에 따라 결과가 달라지며, 쿼리의 성능 또한 상당한 영향을 받는다.  

## 콜레이션 이해
문자 집합은 2개 이상의 콜레이션을 가지고 있는데, 하나의 문자 집합에 속한 콜레이션은 다른 문자 집합과 공유해서 사용할 수 없다.  
또한 테이블이나 칼럼에 문자 집합만 지정하면 해당 문자 집합의 디폴트 콜레이션이 해당 칼럼의 콜레이션으로 지정된다.  
반대로 콜레이션만 지정하면, 해당 콜레이션이 소속된 문자 집합이 묵시적으로 그 칼럼의 문자 집합으로 사용된다.  
`SHOW COLLATION` 명령을 사용해 확인할 수 있다.  

![image](https://github.com/RealMySQL-Study/REAL_MYSQL_STUDY/assets/67637716/19e75974-f2c3-4133-bc81-45b41651e2bd)  

콜레이션의 이름은 2개 또는 3개의 파트로 구분돼 있으며 다음과 같은 의미로 사용된다.  
* 3개의 파트
  * 첫 번째 파트는 문자 집합의 이름
  * 두 번째 파트는 해당 문자 집합의 하위 분류
  * 세 번째 파트는 대소문자나 소문자의 구분 여부, ci이면 대소문자를 구분하지 않는 콜레이션, cs이면 대소문자를 구분하는 콜레이션
 
* 2개의 파트
  * 첫 번쨰 파트는 문자 집합의 이름
  * 두 번째 파트는 항상 "bin"이라는 키워드가 사용(EX: utf8mb4_bin)
  * bin은 이진 데이터(binary)를 의미하며, 이진 데이터로 관리되는 문자열 칼럼은 별도의 콜레이션을 가지지 않는다.
  * 콜레이션이 `xxx_bin`이라면 비교 및 정렬은 실제 문자 데이터의 바이트 값을 기준으로 수행된다.
 
문자열 칼럼의 정렬이나 비교는 항상 해당 문자열 칼럼의 콜레이션에 의해 판단하므로 문자열 칼럼에서는 CHAR나 VARCHAR같은 타입의 이름과 길이만 같다고 해서 똑같은 타입이라고 판단해서는 안된다.  
타입의 이름과 문자열의 길이, 문자 집합과 콜레이션까지 일치해야 똑같은 타입이라고 할 수 있다.  
문자열 칼럼에서는 문자 집합과 콜레이션이 모두 일치해야만 조인이나 WHERE 조건이 인덱스를 효율적으로 사용할 수 있다.  
조인을 수행하는 양쪽 테이블의 칼럼이 문자 집합이나 콜레이션이 다르다면 비교작업에서 콜레이션의 변환이 필요하기 때문에 주의해야한다.  

```
테이블 생성시 문자 집합이나 콜레이션을 적용하는 방법

CREATE TABLE tb_member (
  member_id VARCHAR(20) NOT NULL COLLATE latin1_General_cs,
  member_name VARCHAR(20) NOT NULL COLLATE utf8_bin
)

```  

## utf8mb4 문자 집합의 콜레이션
실제 응용 프로그램의 다국어 지원은 필수적이라 대부분 utf8mb4 문자 집합을 사용할 것이다.  
콜레이션의 이름에 locale이 포함돼 있는지 여부로 언어에 종속적인 콜레이션과 종속적이지 않은 콜레이션으로 구분할 수 있다.  
* utf8mb4_0900_ai_ci : 범용
* utf8mb4_zh_0900_as_cs : 중국어
* utf8mb4_ja_0900_as_cs : 일본어

등등 ..   

일반적인 범용 응용 프로그램이라면 `utf8mb4_0900_ai_ci`면 충분하다.  

default!!  
![image](https://github.com/RealMySQL-Study/REAL_MYSQL_STUDY/assets/67637716/9984a03b-51b0-46ac-98dc-3790453fd992)  

## 비교 방식
mysql에서 문자열 칼럼을 비교하는 방식은 CHAR와 VARCHAR가 거의 같다.  
![image](https://github.com/RealMySQL-Study/REAL_MYSQL_STUDY/assets/67637716/8a4a2905-f2f6-4793-b257-f0c4f9e5d53b)  

![image](https://github.com/RealMySQL-Study/REAL_MYSQL_STUDY/assets/67637716/486961e4-0a2c-4769-bcfa-97d6e677de59)  

위 결과를 보면 공백문자가 비교 결과에 영향을 미친다.  
collation에 따라 공백문자가 영향을 미치는지 아닌지가 다르다.  
pad_attribute를 보면 no_pad라고 나오는데, 대부분은 pad space이지만 utf8mb4_0900으로 시작하는 콜레이션만 no pad이다.  









