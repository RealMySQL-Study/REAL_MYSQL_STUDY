# 스키마 조작(DDL)
MySQL 서버가 업그레이드 되면서 많은 DDL이 온라인 모드로 처리될 수 있게 개선됐지만  
여전히 스키마를 변경하는 작업 중에는 상당히 오랜 시간이 걸리고 많은 부하를 발생시키는 작업들이 있으므로 주의해야한다.  

### 온라인 DDL
MySQL 5.5 이전 버전까지는 테이블의 구조를 변경하는 동안 다른 커넥션에서 DML을 실행할 수 없었다.  
하지만 8.0 버전으로 업그레이드 되면서 대부분의 스키마 변경 작업은 서버에 내장된 온라인 DDL기능으로 처리가 가능해졌다.  

### 온라인 DDL알고리즘
온라인 DDL은 스키마를 변경하는 작업 도중에도 다른 커넥션에서 해당 테이블의 데이터를 변경하거나 조회하는 작업을 가능하게한다.  
ALTER TABLE 명령을 실행하면 다음과 같은 순서로 스키마 변경에 적합한 알고리즘을 찾는다.  
1. ALGORITHM=INSTANT로 스키마 변경이 가능한지 확인 후 선택
2. ALGORITHM=INPLACE로 스키마 변경이 가능한지 확인 후 선택
3. ALGORITHM=COPY 알고리즘 선택

* INSTANT
  * 테이블의 데이터는 전혀 변경하지 않고, 메타데이터만 변경하고 작업 완료.
  * 레코드 건수와 무관하게 작업시간은 매우 짧다.
  * 스키마 변경 도중 테이블의 읽고 쓰기는 대기하게 되지만 변경 시간이 매우 짧기 때문에 크게 영향을 미치지 않음.
* INPLACE
  * 임시 테이블로 데이터를 복사하지 않고 스키마 변경을 실행.
  * 레코드의 복사 작업은 없지만 테이블의 크기에 따라 많은 시간이 소요될 수있다.
  * 스키마 변경 작업 도중에도 테이블의 읽기 쓰기 전부 가능.
  * 다른 커넥션의 쿼리 처리에 대한 영향도는 높지 않다.
* COPY
  * 변경된 스키마를 적용한 임시 테이블을 생성하고, 테이블의 레코드를 모두 임시 테이블로 복사한 후 최종적으로 임시 테이블을 RENAME해서 스키마 변경을 완료한다.
  * 테이브르이 읽기만 가능하고 DML을 실행할 수 없다.
 
온라인 DDL명령은 ALGORITHM과 LOCK옵션이 명시되어 있지 않다면 MYSQL 서버가 적절한 수준의 알고리즘과 잠금 수준을 선택한다.  
``` sql
ALTER TABLEs= salaries CHANGE to_date end_date DATE NOT NULL, AGORITHE=INPLACE, LOCK=NONE;
```

INSTANT 알고리즘은 테이블의 메타데이터만 변경하기 때문에 매우 짧은 시간 동안의 메타데이터 잠금만 필요로 한다.  
그래서 INSTANT알고리즘을 사용하는 경우에넌 LOCK옵션은 명시할 수 없다.  

* NONE : 아무런 잠금을 걸지 않음
* SHARED: 스키마 변경중 읽기는 가능하지만 쓰기는 불가함
* EXCLUSIVE: 읽기 쓰기 불가함

INPLACE 알고리즘을 사용하는 경우  
* 데이터 재구성이 필요한 경우(PK 추가): 잠금을 필요로 하지 않기 떄무에 읽기 쓰기는 가능하지만 레코드 건 수에 따라 오랜 시간이 소요될 수 있다.
* 데이터 재구성이 필요없는 경우(칼럼의 이름만 변경): INPLACE알고리즘을 사용하지만 INSTANT 알고리즘과 비슷하게 매우 빨리 완료될 수 있다.

온라인 DDL기능은 버전별로 많은 차이가 있으므로, 사용중인 버전의 MYSQL 메뉴얼을 살펴보고 테이블 리빌드가 필요한지 확인후 진행하고,  
스키마 변경 작업을 실행학리 전에 먼저 메뉴얼과 테스트를 진행해 보자.  

### 온라인 처리 가능한 스키마 변경
![image](https://github.com/RealMySQL-Study/REAL_MYSQL_STUDY/assets/67637716/33d40e7e-42a4-43fa-a86d-92341f241f4f)  
![image](https://github.com/RealMySQL-Study/REAL_MYSQL_STUDY/assets/67637716/36af5c2f-ebba-4a13-95ec-d75aecbd808a)  
![image](https://github.com/RealMySQL-Study/REAL_MYSQL_STUDY/assets/67637716/60c5012f-5763-4b61-a333-d837bf55e6ba)  
![image](https://github.com/RealMySQL-Study/REAL_MYSQL_STUDY/assets/67637716/4ae1ddef-5e76-44dd-b5ce-eedcc5fde19e)  

### 데이터베이스 변경
#### 데이터베이스 생성
``` sql
CREATE DATABASE [IF NOT EXISTS] employees;
CREATE DATABASE [IF NOT EXISTS[ employees CHARACTER SET utf8mb4;
CREATE DATABASE [IF NOT EXISTS] employees CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;
```

첫 번째 명령은 기본 문자 집합과 콜레이션으로 생성 
두 번째와 세 번째 명령은 별도의 문자 집합과 콜레이션이 지정된 데이터베이스를 생성.  
이미 동일한 이름의 데이터베이스가 있다면 DDL은 에러를 유발하지만 `IF NOT EXISTS` 키워드를 사용하면 데이터베이스가 없는 경우에만 생성하고, 이미 있다면 이 DDL은 무시된다.  

* 콜레이션: https://blog.naver.com/sory1008/223071678680

#### 데이터베이스 목록
``` sql
SHOW DATABASES;
SHOW DATABASES LIKE '%emp%';
```

접속된 MYQSL 서버가 가지고 있는 데이터베이스의 목록을 나열한다.  
단 권한을 가지고 있는 데이터베이스의 목록만 표시하며, SHOW DATABASES 권한이 있어야한다.  

### 데이터베이스 선택
``` sql
USE employees;
```
기본 데이터베이스를 선택하는 명령이다.  
기본 데이터베이스에 존재하지 않는 테이블이나 프로시저를 사용하려면 다음과 같이 데이터베이스 이름을 반드시 명시해야한다.  
``` sql
SELECT * FROM employees.departments
```  

#### 데이터베이스 속성 변경
``` sql
ALTER DATABASE employees CHARACTER SET = euckr;
ALTER DATABASE employees CHARACTER SET euckr COLLATE=euckr_korean_ci;
```

### 데이터베이스 삭제
``` sql
DROP DATABASE [IF EXISTS] employees;
```

### 테이블 생성
``` sql
CREATE [TEMPORARY] TABLE [IF NOT EXISTS] tb_test (
 member_id BIGINT [UNSIGNED] [AUTO_INCREMENT],
 nickname CHAR(20) [character set 'utf8'] [COLLATE 'utf8_general_ci'] [NOT NULL],
 home_url VARCHAR(200) [COLLATE 'latin1_general_cs'],
 birth_year SMALLINT(4) [UNSIGNED] [ZEROFILL],
 member_point INT [NOT NULL] [DEFAULT 0],
 register_dttm DATETIME [NOT NULL],
 modified_ts TIMESTAMP [NOT NULL] [DEFAULT CURRENT_TIMESTAMP],
 gender ENUM('Female', 'Male') [NOT NULL],
 hobby SET('Reading', 'Game', 'Sports'),
 profile TEXT,
 session_data BLOB,
 PRIMARY KEY(member_id),
 UNIQUE INDEX ux_nickname (nickname),
 INDEX ix_registeredttm(registered_dttm) 
) ENGINE=INNODB;
```

TEMPORARY 키워드를 사용하면 해당 세션에서만 사용 가능한 임시 테이블을 생성한다.  
별도의 엔진을 선택하지 않으면 디폴트로 INNODB를 선택된다.  

각 컬럼은 컬럼명+컬럼타임+타입별 옵션+NULL값 여부+기본값 의 순서로 명시한다.  
타입이나 속성의 특징은 15장에서 자세하게..  

### 테이블 구조 조회
``` sql
SHOW CREATE TABLE employees \G;
DESC employees;
```

첫 번째 명령을 사용하면 테이블의 CREATE TABLE 문장을 표시해준다.  
MYSQL서버가 테이블의 메타 정보를 읽어서 이를 CREATE TABLE명령으로 재작성해서 보여주는 것이다.  
칼럼의 목록과 인덱스, 외래키 정보를 동시에 보여주기 때문에 SQL을 튜닝하거나 테이블의 구조를 확인할 때 주로 이 명령을 사용한다.  

![image](https://github.com/RealMySQL-Study/REAL_MYSQL_STUDY/assets/67637716/a7f48aa8-6522-4221-9521-8766798bf79d)  

두 번째 명령은 DESCRIBE의 약어로 칼럼 정보를 보기 편한 표 형태로 표시해준다.  
그러나 전체적인 구조를 한 번에 확인하기는 어렵다.  
![image](https://github.com/RealMySQL-Study/REAL_MYSQL_STUDY/assets/67637716/ef94af1d-de0b-49cf-928e-24e59a747d62)  

### 테이블명 변경
```
RENAME TABLE table1 TO table2;
RENAME TABLE db1.table1 TO db2.table2;
```

RENAME 명령은 테이블의 이름 변경뿐만 아니라 다른 데이터베이스로 테이블을 이동할 때도 사용가능하다.  
첫 번째 명령과 같이 동일 데이터베이스 내에서 테이블이름만 변경하는 경우 단순 메타 정보만 변경하기 때문에 매우 빠르게 처리된다.  
두 번쨰 명령과 같이 데이터베이스를 변경하는 경우에는 메타 정보뿐만 아니라 테이블이 저장된 파일까지 다른 디렉터리(데이터베이스별로 별도 디렉터리가 할당되기 떄문)로 이동해야한다.  
따라서 데이터 파일의 크기에 비례해서 시간이 소요될 것이다.  
<br/>  

떄로는 일정 주기로 테이블을 교체해야하는 경우도 있다.  
``` sql
// 새로운 테이블 및 데이터 생성
CREATE TABLE batch_new (...);
INSERT INTO batch_new SELECT ...;

// 기존 테이브로가 교체
RENAME TABLE batch TO batch_old;
RENAME TABLE batch_new TO batch;
```

이런 경우 기존 테이블과 신규 테이블을 교체하는 동안 일시적으로 batch 테이블이 없어지는 시점이 발생한다.  
이와 같은 문제점을 막기위해 RENAME TABLE명령은 여러 테이블의 RENAME명령을 하나의 문장으로 묶어서 실행할 수 있다.  

``` sql
RENAME TABLE batch TO batch_old, batch_new TO batch; 
```

이렇게 여러 테이블의 RENAME명령을 하나의 문장으로 묶으면, 명시된 모든 테이블에 대해 잠금을 걸고 테이블의 이름 변경을 실행한다.  
APPLICATION입장에서 보면 batch 테이블을 조회하려고 할 때 잠금이 걸려있기 떄문에 대기한다.  

### 테이블 상태 조회
mysql의 모든 테이블은 만들어진 시간, 대략의 레코드 건수, 데이터 파일의 크기 등의 정보를 가지고 있다.  
이러한 정보를 조회할 수 있는 명령이 `SHOW TABLE STATUS ...` 이다.  
![image](https://github.com/RealMySQL-Study/REAL_MYSQL_STUDY/assets/67637716/e8b1a004-9fd7-42b0-837d-d579b19ffaea)  

어떤 스토리지 엔진을 사용하는지, 데이터 파일의 포맷으로 무엇을 사용하는지 등을 조회할 수 있다.  
위 명령 뿐 아니라 `information_schema` 테이블을 조회하는 것도 가능하다.  
![image](https://github.com/RealMySQL-Study/REAL_MYSQL_STUDY/assets/67637716/b524bb5d-3fd8-4494-a2e0-07960f4abc50)  

information_schema 데이터베이스의 테이블들은 테이블들에 대한 다양한 정보를 제공한다.  
* 데이터베이스 객체에 대한 메타 정보
* 테이블과 칼럼에 대한 간략한 통계정보
* 전문 검색 디버깅을 위한 뷰(view)
* 압축 실행과 실패 횟수에 대한 집계

### 테이블 삭제
``` sql
DROP TABLE [IF EXISTS] table1;
```










